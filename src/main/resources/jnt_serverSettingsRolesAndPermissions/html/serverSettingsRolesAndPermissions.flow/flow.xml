<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="
		http://www.springframework.org/schema/webflow
		http://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <var name="handler" class="org.jahia.modules.rolesmanager.RolesAndPermissionsHandler"/>

    <view-state id="view" >
        <on-render>
            <evaluate expression="handler.roles" result="requestScope.roles"/>
        </on-render>

        <transition on="addRole" to="viewRole">
            <evaluate expression="handler.addRole(requestParameters.newRole, requestParameters.parentRoleId, requestParameters.roleType, messageContext)" />
        </transition>

        <transition on="viewRole" to="viewRole">
            <evaluate expression="handler.getRole(requestParameters.uuid, true)" result="handler.roleBean"/>
        </transition>

        <transition on="deleteRoles" to="view">
            <evaluate expression="handler.deleteRoles(requestParameters.uuids)" />
        </transition>

    </view-state>

    <view-state id="viewRole">
        <transition on="rolesList" to="view"/>

        <transition on="saveRole" to="viewRole">
            <evaluate expression="handler.storeValues(requestParameters.selectedPermissions,requestParameters.partialSelectedPermissions)" />
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
            <evaluate expression="handler.save()"/>
        </transition>

        <transition on="viewRoleDetails" to="viewRoleDetails">
            <evaluate expression="handler.storeValues(requestParameters.selectedPermissions,requestParameters.partialSelectedPermissions)" />
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
        </transition>

        <transition on="switchContext" to="viewRole">
            <evaluate expression="handler.storeValues(requestParameters.selectedPermissions,requestParameters.partialSelectedPermissions)" />
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
            <evaluate expression="handler.setCurrentContext(requestParameters.context)" />
        </transition>

        <transition on="switchGroup" to="viewRole">
            <evaluate expression="handler.storeValues(requestParameters.selectedPermissions,requestParameters.partialSelectedPermissions)" />
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
            <evaluate expression="handler.setCurrentGroup(requestParameters.context,requestParameters.groupTab)" />
        </transition>

        <transition on="addContext" to="viewRole">
            <evaluate expression="handler.storeValues(requestParameters.selectedPermissions,requestParameters.partialSelectedPermissions)" />
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
            <evaluate expression="handler.addContext(requestParameters.newContext)" />
        </transition>

        <transition on="removeContext" to="viewRole">
            <evaluate expression="handler.storeValues(requestParameters.selectedPermissions,requestParameters.partialSelectedPermissions)" />
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
            <evaluate expression="handler.removeContext(requestParameters.context)" />
        </transition>

        <transition on="revertRole" to="viewRole">
            <evaluate expression="handler.revertRole()" />
        </transition>

    </view-state>

    <view-state id="viewRoleDetails">
        <transition on="rolesList" to="view"/>

        <transition on="saveRole" to="viewRoleDetails">
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
            <evaluate expression="handler.save()"/>
        </transition>

        <transition on="viewRoleDetails" to="viewRoleDetails">
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
        </transition>

        <transition on="switchContext" to="viewRole">
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
            <evaluate expression="handler.setCurrentContext(requestParameters.tab)" />
        </transition>

        <transition on="addContext" to="viewRole">
            <evaluate expression="handler.storeDetails(requestParameters.title,requestParameters.description,requestParameters.hidden)" />
            <evaluate expression="handler.addContext(requestParameters.newContext)" />
        </transition>

    </view-state>

</flow>
